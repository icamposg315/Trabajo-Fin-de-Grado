<!DOCTYPE html>
<html lang="es">
<%- include('../partial/head.ejs') %>

<body>
    <%- include('../partial/nav.ejs') %>
    <main class="container my-5">
        <h2>Carrito</h2>
        <div id="carritoContainer"></div>
        <form id="checkoutForm">
            <div class="mb-3">
                <label for="direccion_envio" class="form-label">Dirección de Envío</label>
                <input type="text" class="form-control" id="direccion_envio" required>
            </div>
            <button type="submit" class="btn btn-primary">Realizar Pedido</button>
        </form>
    </main>
    <%- include('../partial/footer.ejs') %>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const carritoContainer = document.getElementById('carritoContainer');
            const checkoutForm = document.getElementById('checkoutForm');

            const cargarCarrito = async () => {
                try {
                    const response = await fetch('/api/carrito');
                    if (!response.ok) {
                        throw new Error('Error al obtener el carrito');
                    }
                    const carrito = await response.json();
                    let carritoHTML = '';
                    let total = 0;
                    carrito.forEach(item => {
                        carritoHTML += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Artículo: ${item.nombre}</h5>
                                    <p class="card-text">Cantidad: ${item.cantidad}</p>
                                    <p class="card-text">Precio: ${item.precio} €</p>
                                </div>
                            </div>
                        `;
                        total += item.cantidad * item.precio;
                    });
                    carritoHTML += `<h3>Total: ${total.toFixed(2)} €</h3>`;
                    carritoContainer.innerHTML = carritoHTML;
                } catch (error) {
                    console.error('Error al cargar el carrito:', error);
                }
            };

            checkoutForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const direccion_envio = document.getElementById('direccion_envio').value;
                const usuario_id = 1; // Deberías obtener el ID del usuario de la sesión o autenticación

                try {
                    const response = await fetch('/api/pedido', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ usuario_id, direccion_envio })
                    });
                    if (!response.ok) {
                        throw new Error('Error al realizar el pedido');
                    }
                    const result = await response.json();
                    alert('Pedido realizado con éxito');
                    window.location.reload();
                } catch (error) {
                    console.error('Error al realizar el pedido:', error);
                }
            });

            cargarCarrito();
        });
    </script>
    <script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="module" src="/script/bucle.js"></script>
</body>
</html>
